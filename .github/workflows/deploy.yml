name: FastAPI Docker CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    # 1ë‹¨ê³„ì—ì„œ ì„¤ì •í•œ self-hosted ë¼ë²¨ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    runs-on: self-hosted

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # ë³€ê²½ íŒŒì¼ ë¹„êµë¥¼ ìœ„í•´ ì´ì „ ì»¤ë°‹ ê¸°ë¡ë„ ê°€ì ¸ì˜µë‹ˆë‹¤.

      - name: Check for configuration changes
        id: check_changes
        run: |
          # ë¹Œë“œê°€ í•„ìš”í•œ ì£¼ìš” íŒŒì¼ë“¤ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
          # Dockerfile, docker-compose.yml, requirements.txt ì¤‘ í•˜ë‚˜ë¼ë„ ë³€ê²½ë˜ë©´ build_neededë¥¼ trueë¡œ ì„¤ì •
          if git diff --name-only HEAD^ HEAD | grep -E 'Dockerfile|docker-compose.yml|requirements.txt'; then
            echo "build_needed=true" >> $GITHUB_OUTPUT
          else
            echo "build_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy with Docker Compose
        run: |
          if [ "${{ steps.check_changes.outputs.build_needed }}" == "true" ]; then
            echo "ğŸš€ Major changes detected. Rebuilding all services..."
            docker compose up -d --build
          else
            echo "âš¡ Minor changes detected. Smart updating..."
            # ì„œë¹„ìŠ¤ ì´ë¦„ì„ íŠ¹ì •í•˜ì§€ ì•Šìœ¼ë©´, docker composeê°€ ì•Œì•„ì„œ 
            # ì½”ë“œ/ì„¤ì •ì´ ë³€ê²½ëœ ì»¨í…Œì´ë„ˆë§Œ ê°ì§€í•´ì„œ ì¬ì‹œì‘í•©ë‹ˆë‹¤.
            docker compose up -d
          fi

      - name: Clean up unused images
        run: docker image prune -f
